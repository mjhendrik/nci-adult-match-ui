language: node_js
node_js: stable

sudo: false

services:
  - docker

install: true  # yarn bug
services:
  - docker
addons:
  firefox: "45.0"

branches:
  only: master

os:
  - linux
#  - osx

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew outdated xctool || brew upgrade xctool; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export CHROME_BIN=chromium-browser; fi  # Karma CI
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew cask install google-chrome; fi  # Karma CI
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export DISPLAY=:99.0; fi
  #Set up Docker exports
  - export AUTHOR=`git --no-pager show -s --format='%an <%ae>'`
  - export DATE=`TZ=America/New_York date "+%m-%d-%y-%H%M"`
  - export DATE_TM=`TZ=America/New_York date "+%m-%d-%y %H:%M"`
  - export DOCKER_IMAGE="matchbox/nci-adult-match-ui"
  # - echo "MATCH UI Build# $TRAVIS_BUILD_NUMBER" > app/views/build_number.html &&
  #       echo "Build Time $DATE_TM" >> app/views/build_number.html
  # - cat ./app/views/build_number.html

before_script:
  - npm install
  # - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sh -e /etc/init.d/xvfb start; fi
  # - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then nohup bash -c "webdriver-manager start 2>&1 &"; fi  # Protractor CI

after_failure:
  - cat /home/travis/build/nci-adult-match-ui/npm-debug.log

after_success:
  - cat test/coverage/report-lcov/lcov.info | ./node_modules/.bin/codacy-coverage		
  - docker images
  # - docker push $DOCKER_IMAGE # Pushes both date and latest
   #Deploy to AWS IntTest
  # - docker run -it --rm -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY 
  #   -e AWS_DEFAULT_REGION=us-east-1 silintl/ecs-deploy 
  #   --cluster AdultMatch-IntTest-Backend --service-name AdultMatch-nci-match-ui-INTTEST 
  #   -i $DOCKER_IMAGE:$DATE
  # #Trigger Travis bdd tests
  # - curl -s -X POST -H "Content-Type:application/json" -H "Accept:application/json" 
  #   -H "Travis-API-Version:3" -H "Authorization:token $TRAVIS_TOKEN" 
  #   -d "{\"request\":{\"message\":\"Triggered by nci-adult-match-ui $TRAVIS_COMMIT\", \"branch\":\"master\", \"config\":{\"env\":{\"matrix\":[\"TRIGGER_REPO=nci-match-ui;TRIGGER_VER=$DATE;CUC_TAG=@ui;AUTHOR=$AUTHOR\"]}}}}" 
  #   https://api.travis-ci.org/repo/CBIIT%2Fnci-adult-match-bddtests/requests

notifications:
  slack: clinicalbiomed:gRp5LqKElNOjUUMPLlq4qC1j

cache:
  directories: node_modules

script:
  # - npm run tests.all && npm run build.dev
  - npm run build.dev
    #Build Docker image
  - docker build -f .docker/dockerfile.httpd .
  # - docker build -f ./.docker/dockerfile.httpd --build-arg buildnum=$TRAVIS_BUILD_ID -t $DOCKER_IMAGE:$DATE -t $DOCKER_IMAGE:latest .
  # - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
